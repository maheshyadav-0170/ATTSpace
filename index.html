<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Login Page</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body, html {
      height: 100%;
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f4f7fa;
    }
    .container-fluid {
      height: 100%;
    }
    .split-left {
      background: linear-gradient(135deg, #005f73 0%, #0a9396 100%);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      text-align: center;
    }
    .split-left h1 {
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .split-right {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #ffffff;
    }
    .login-card {
      width: 100%;
      max-width: 460px;
      padding: 2.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      background-color: #fff;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .login-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
    }
    .card-title {
      font-size: 1.75rem;
      font-weight: 600;
      text-align: center;
      color: #1a202c;
      margin-bottom: 1.5rem;
    }
    .logo {
      display: block;
      margin: 0 auto 1rem;
      width: 60px;
      height: 60px;
      background-color: #e9ecef;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #005f73;
      font-size: 1.1rem;
      transition: background-color 0.3s ease;
    }
    .form-label {
      font-weight: 500;
      color: #374151;
    }
    .form-control {
      border-radius: 8px;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .form-control:focus {
      border-color: #005f73;
      box-shadow: 0 0 0 3px rgba(0, 95, 115, 0.1);
    }
    .btn-primary {
      background-color: #005f73;
      border-color: #005f73;
      border-radius: 8px;
      padding: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .btn-primary:hover {
      background-color: #0a9396;
      border-color: #0a9396;
      transform: translateY(-2px);
    }
    .footer-text {
      font-size: 0.85rem;
      text-align: center;
      color: #6b7280;
      margin-top: 2rem;
    }
    .footer-text a {
      text-decoration: none;
      color: #005f73;
      font-weight: 500;
      transition: color 0.3s ease;
    }
    .footer-text a:hover {
      color: #0a9396;
      text-decoration: underline;
    }
    .alert {
      border-radius: 8px;
      padding: 0.75rem;
      font-size: 0.9rem;
    }
    .otp-input {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }
    .otp-input input {
      width: 40px;
      text-align: center;
      font-size: 1.2rem;
    }
    @media (max-width: 767px) {
      .split-left {
        display: none;
      }
      .split-right {
        background: linear-gradient(135deg, #f4f7fa 0%, #ffffff 100%);
      }
      .login-card {
        margin: 1rem;
        padding: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container-fluid h-100">
    <div class="row h-100">
      <!-- Left Half -->
      <div class="col-md-6 split-left d-none d-md-flex">
        <h1>Welcome to AT&T</h1>
      </div>

      <!-- Right Half -->
      <div class="col-md-6 split-right">
        <div class="card login-card">
          <div>
            <!-- Logo Placeholder -->
            <div class="logo">AT&T</div>

            <h3 class="card-title" id="cardTitle">Sign In</h3>

            <div id="alertMessage" class="alert d-none"></div>

            <div id="formContainer">
              <form id="attuidForm">
                <div class="mb-4">
                  <label for="attuid" class="form-label">ATTUID</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    id="attuid" 
                    placeholder="Enter your ATTUID" 
                    required
                  >
                </div>
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary">Next</button>
                </div>
              </form>
            </div>
          </div>

          <div class="footer-text">
            <p><a href="#">Help</a> · <a href="#">Privacy</a> · <a href="#">Terms</a></p>
            <p class="mt-2">© 2025 AT&T – Confidential</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    const API_URL = 'http://localhost:4000/auth/check-attuid';
    const formContainer = document.getElementById('formContainer');
    const alertMessage = document.getElementById('alertMessage');
    const cardTitle = document.getElementById('cardTitle');

    function showAlert(message, type = 'info') {
      alertMessage.classList.remove('d-none', 'alert-danger', 'alert-success', 'alert-info');
      alertMessage.classList.add(`alert-${type}`);
      alertMessage.textContent = message;
    }

    function clearAlert() {
      alertMessage.classList.add('d-none');
      alertMessage.textContent = '';
    }

    // Reusable function to attach ATTUID form submission handler
    function attachAttuidFormHandler() {
      const attuidForm = document.getElementById('attuidForm');
      if (attuidForm) {
        attuidForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          const attuid = document.getElementById('attuid').value.trim();
          if (!attuid) {
            showAlert('Please enter a valid ATTUID.', 'danger');
            return;
          }

          try {
            const response = await fetch(API_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ attuid })
            });
            const data = await response.json();

            if (!response.ok) {
              showAlert(data.message || 'An error occurred. Please try again.', 'danger');
              return;
            }

            showAlert(data.message, 'info');

            if (data.next === 'otp') {
              renderOtpForm(attuid);
            } else if (data.next === 'password') {
              renderPasswordForm(attuid);
            }
          } catch (err) {
            console.error('ATTUID submission error:', err);
            showAlert('Failed to connect to the server. Please try again later.', 'danger');
          }
        });
      }
    }

    // Initial attachment of ATTUID form handler
    attachAttuidFormHandler();

    // Render OTP form
    function renderOtpForm(attuid) {
      cardTitle.textContent = 'Enter OTP';
      formContainer.innerHTML = `
        <form id="otpForm">
          <div class="mb-4">
            <label for="otp" class="form-label">One-Time Password (OTP)</label>
            <div class="otp-input">
              ${Array(6).fill().map((_, i) => `
                <input 
                  type="text" 
                  class="form-control" 
                  maxlength="1" 
                  pattern="[0-9]" 
                  required
                  oninput="moveToNext(this, ${i})"
                >
              `).join('')}
            </div>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Verify</button>
          </div>
        </form>
      `;

      document.getElementById('otpForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const otpInputs = document.querySelectorAll('.otp-input input');
        const otp = Array.from(otpInputs).map(input => input.value).join('');
        if (otp.length !== 6 || !/^\d{6}$/.test(otp)) {
          showAlert('Please enter a valid 6-digit OTP.', 'danger');
          return;
        }

        try {
          const response = await fetch('http://localhost:4000/auth/verify-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ attuid, otp })
          });
          const data = await response.json();

          if (!response.ok) {
            showAlert(data.message || 'Invalid OTP. Please try again.', 'danger');
            return;
          }

          showAlert(data.message, 'success');
          if (data.next === 'set-password') {
            renderSetPasswordForm(attuid);
          }
        } catch (err) {
          console.error('OTP submission error:', err);
          showAlert('Failed to verify OTP. Please try again later.', 'danger');
        }
      });
    }

    // Move to next OTP input
    function moveToNext(current, index) {
      if (current.value.length === 1 && index < 5) {
        document.querySelectorAll('.otp-input input')[index + 1].focus();
      }
    }

    // Render Password form
    function renderPasswordForm(attuid) {
      cardTitle.textContent = 'Enter Password';
      formContainer.innerHTML = `
        <form id="passwordForm">
          <div class="mb-4">
            <label for="password" class="form-label">Password</label>
            <input 
              type="password" 
              class="form-control" 
              id="password" 
              placeholder="Enter your password" 
              required
            >
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Login</button>
          </div>
        </form>
      `;

      document.getElementById('passwordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const password = document.getElementById('password').value;
        if (!password) {
          showAlert('Please enter a valid password.', 'danger');
          return;
        }

        try {
          const response = await fetch('http://localhost:4000/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ attuid, password })
          });
          const data = await response.json();

          if (!response.ok) {
            showAlert(data.message || 'Invalid credentials. Please try again.', 'danger');
            return;
          }

          showAlert('Login successful! Redirecting...', 'success');
          // Store token (if needed) and redirect to /home
          localStorage.setItem('authToken', data.token);
          setTimeout(() => {
            window.location.href = '/home';
          }, 1000);
        } catch (err) {
          console.error('Password submission error:', err);
          showAlert('Failed to login. Please try again later.', 'danger');
        }
      });
    }

    // Render Set Password form
    function renderSetPasswordForm(attuid) {
      cardTitle.textContent = 'Set Password';
      formContainer.innerHTML = `
        <form id="setPasswordForm">
          <div class="mb-4">
            <label for="password" class="form-label">New Password</label>
            <input 
              type="password" 
              class="form-control" 
              id="password" 
              placeholder="Enter your new password" 
              required
            >
          </div>
          <div class="mb-4">
            <label for="confirmPassword" class="form-label">Confirm Password</label>
            <input 
              type="password" 
              class="form-control" 
              id="confirmPassword" 
              placeholder="Confirm your password" 
              required
            >
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Set Password</button>
          </div>
        </form>
      `;

      document.getElementById('setPasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (!password || password !== confirmPassword) {
          showAlert('Passwords do not match or are invalid.', 'danger');
          return;
        }

        try {
          const response = await fetch('http://localhost:4000/auth/set-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ attuid, password })
          });
          const data = await response.json();

          if (!response.ok) {
            showAlert(data.message || 'Failed to set password. Please try again.', 'danger');
            return;
          }

          showAlert(data.message, 'success');
          setTimeout(() => {
            // Reset to initial ATTUID form
            formContainer.innerHTML = `
              <form id="attuidForm">
                <div class="mb-4">
                  <label for="attuid" class="form-label">ATTUID</label>
                  <input 
                    type="text" 
                    class="form-control" 
                    id="attuid" 
                    placeholder="Enter your ATTUID" 
                    required
                  >
                </div>
                <div class="d-grid">
                  <button type="submit" class="btn btn-primary">Next</button>
                </div>
              </form>
            `;
            cardTitle.textContent = 'Sign In';
            showAlert('Please sign in with your new password.', 'info');
            // Reattach ATTUID form handler
            attachAttuidFormHandler();
          }, 2000);
        } catch (err) {
          console.error('Set password error:', err);
          showAlert('Failed to set password. Please try again later.', 'danger');
        }
      });
    }
  </script>
</body>
</html>